{"data":{"site":{"siteMetadata":{"title":"About web performance and sites with energy low.","author":"Dmitry Schegolihin"}},"markdownRemark":{"id":"a1f1de84-7708-56f0-b228-6849b2d8b511","excerpt":"Sometimes is required to identify the limitations of performance and bottlenecks of an application in order to make the most efficient use…","html":"<p>Sometimes is required to identify the limitations of performance and bottlenecks of an application in order to make the most efficient use of its resources. Detect a <code class=\"language-text\">memory leaks</code> for you apps may be critical for production environments. Let’s look at how to identify such moments using <code class=\"language-text\">Yandex Tank</code> benchmark.</p>\n<h2>Setup Yandex Tank</h2>\n<p>In first we create directory and config file:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">mkdir</span> ~/loadtest <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">touch</span> load.yaml</code></pre></div>\n<p>Add next configuration to <code class=\"language-text\">load.yaml</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">phantom:\n  address: 192.168.20.117:3000 <span class=\"token comment\"># [Target's address]:[target's port]</span>\n  uris:\n    - /\n  load_profile:\n    load_type: rps <span class=\"token comment\"># schedule load by defining requests per second</span>\n    schedule: line<span class=\"token punctuation\">(</span>1, 10, 10m<span class=\"token punctuation\">)</span> <span class=\"token comment\"># starting from 1rps growing linearly to 10rps during 10 minutes</span>\nconsole:\n  enabled: <span class=\"token boolean\">true</span> <span class=\"token comment\"># enable console output</span>\ntelegraf:\n  enabled: <span class=\"token boolean\">false</span> <span class=\"token comment\"># let's disable telegraf monitoring for the first time</span></code></pre></div>\n<p>Important sections <code class=\"language-text\">address</code>, <code class=\"language-text\">uris</code> and <code class=\"language-text\">schedule</code>. For <code class=\"language-text\">address</code> key need setup <code class=\"language-text\">host</code> and <code class=\"language-text\">port</code> for you tested application.</p>\n<p>Then we can start <code class=\"language-text\">Yandex Tank</code> with using prepared Docker image (if you use macosx - need install <code class=\"language-text\">Docker for Mac</code>)</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">docker run -v <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">pwd</span><span class=\"token variable\">)</span></span>:/var/loadtest -v <span class=\"token variable\">$SSH_AUTH_SOCK</span>:/ssh-agent -e SSH_AUTH_SOCK<span class=\"token operator\">=</span>/ssh-agent -v <span class=\"token variable\">$HOME</span>/.ssh:/root/.ssh --net <span class=\"token function\">host</span> -it direvius/yandex-tank</code></pre></div>\n<p>And see output:</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b9a6bb2364ca5623003b30d2c722f06c/d4f7b/console-output.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 42.43723208818126%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABS0lEQVQY021Q2WrDMBD0V8RNHMmHJFuSj/q+ZPmAEPKQD2geS0oo+f8P6NpQKKTDPGjZnZ1ZGdmGKIqapum6blB6nhbVqb7roVRKaa27tsumXN1UpjMZciZYnMbQNdq27fseJqZpqqoqEVEuU058aruH/RvANM2duZNc5nEe+DwIAtd17Q0GGA7DMI7jsiywJUviOk+LJKreY0lJKFaAIAxDPepxUJEQhBCMEcbYAHfwnOf5dDpByKIoIX1ZVWEUaz1er9fL5XI+n0HgeR7nnBKC0KpcxXGSpGmaF0Vd1+v1ea6GoSjLqmk+brevx+P7+fy8333ftywLbcC/MCCTFIIz5joOnLJGZExQGlICR0viJYxGjDqOjV9gSOjxAEa5D7/IoJSMJJ5beU7NSE3c2rNr4niOjV7F1vG4EqHjH1oIH1ai/UZ4YPsf5x+/kVFOVrUgMAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Console output\"\n        title=\"\"\n        src=\"/static/b9a6bb2364ca5623003b30d2c722f06c/b9e4f/console-output.png\"\n        srcset=\"/static/b9a6bb2364ca5623003b30d2c722f06c/cf440/console-output.png 148w,\n/static/b9a6bb2364ca5623003b30d2c722f06c/d2d38/console-output.png 295w,\n/static/b9a6bb2364ca5623003b30d2c722f06c/b9e4f/console-output.png 590w,\n/static/b9a6bb2364ca5623003b30d2c722f06c/f9b6a/console-output.png 885w,\n/static/b9a6bb2364ca5623003b30d2c722f06c/2d849/console-output.png 1180w,\n/static/b9a6bb2364ca5623003b30d2c722f06c/bbefa/console-output.png 1770w,\n/static/b9a6bb2364ca5623003b30d2c722f06c/d4f7b/console-output.png 3266w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>You can create alias for simplify using (for macosx):</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token keyword\">echo</span> <span class=\"token string\">\"alias tank=\\\"docker run -v <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">pwd</span><span class=\"token variable\">)</span></span>:/var/loadtest -v <span class=\"token variable\">$SSH_AUTH_SOCK</span>:/ssh-agent -e SSH_AUTH_SOCK=/ssh-agent -v <span class=\"token variable\">$HOME</span>/.ssh:/root/.ssh --net host -it direvius/yandex-tank\\\"\"</span> <span class=\"token operator\">>></span> ~/.bash_profile <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">source</span> ~/.bash_profile</code></pre></div>\n<p>And using one:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">tank</code></pre></div>\n<h2>Visualizing Data</h2>\n<p>For visualize load metrics out of the box we can setup the <a href=\"https://overload.yandex.net/mainpage/guide#install\">Overload Beta</a> service:</p>\n<p>Example view of <code class=\"language-text\">Quantiles</code>:</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1d2623c892938e659dff6e5dc392ee9b/17a00/overload-quantiles.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 48.634590377113135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAACGElEQVQoz5VRS2sTYRSd3+PelTtBpO+EhtgWCu5cCb42IqhYsVFpq2kqMUXbpgpKsBoULcUUkqBmIu2kiU0TQl5tE6dJ03l9M/PN9xpn6C/wclbnnnvv4R6ONKu0dUD3G0zu2f9TzLI4bcynX54EPg+KvmAORehpjzICCaTM5RghBCGKEbEsqKhQA3LrEOQEDox6jYlL+lA/fj3v7qOUYWyYoHK0V2wJQoXvdA6gonS77V63jQBApuHItI6oZTOc6vNo4355sA88fwwtaEgSUfVGqxLLhDfyS592oj9rSX6fT9UTeVEASK/3qiZD5ZoAsjzX8wxLfp8y2GcEZ4htO/acxZWT4tvt63Hhxkru9tqf5QgfWt2a+VBYbErVL8WPhU7+c2ZVTCc44B81Jid07zAMPcM2hch11ZAz8ezAesYbFsZf8ncebt56lLj6NHkzWVufS02/K7yJfL9XTqxx2sBF4B0CF86DwAPIpGOt6QyL0tfCjzOl9NlU+VxsxxvdHgn/6n+SHFnZmp5KXLm/eW0qPlbaeM8ZCyG4GDHng9q3OKaSDBqU2oaeU3bv6qWAIgbq7dn6cbD+d7bcntsVY8Lhq1RzKV1cONr7zQGEIMbYtiFz3owtC+kmkFRVBVA1dMtUNUlDwLBUAxz3iK6bso5PVGRhwmzuNBvbOcfcctNywibYDZci5gJTYjFKKEEOHN6CpglNR/wP/6b1RElFBDEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Overload Quantiles\"\n        title=\"\"\n        src=\"/static/1d2623c892938e659dff6e5dc392ee9b/b9e4f/overload-quantiles.png\"\n        srcset=\"/static/1d2623c892938e659dff6e5dc392ee9b/cf440/overload-quantiles.png 148w,\n/static/1d2623c892938e659dff6e5dc392ee9b/d2d38/overload-quantiles.png 295w,\n/static/1d2623c892938e659dff6e5dc392ee9b/b9e4f/overload-quantiles.png 590w,\n/static/1d2623c892938e659dff6e5dc392ee9b/f9b6a/overload-quantiles.png 885w,\n/static/1d2623c892938e659dff6e5dc392ee9b/2d849/overload-quantiles.png 1180w,\n/static/1d2623c892938e659dff6e5dc392ee9b/17a00/overload-quantiles.png 1538w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Drawdowns towards the end of the test indicate a restart of the PODs, respectively, memory leaks or high consumption, followed by GC (Garbage Collector) cleaning.</p>\n<h2>Detecting memory leaks for nodejs apps</h2>\n<p><a href=\"https://github.com/Unitech/pm2\">pm2</a> is best Process Manager with a built-in Load Balancer. We can use <code class=\"language-text\">pm2</code> for monitoring memory using you <code class=\"language-text\">nodejs</code> apps.</p>\n<p>Install <code class=\"language-text\">pm2</code> globally:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> pm2@latest -g</code></pre></div>\n<p>Usable tips:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">pm2 monit\npm2 imonit</code></pre></div>\n<p><code class=\"language-text\">Process List</code> is important section:</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0ce027380578a5a9415fdb466efbf208/0eb29/pm2-process-list.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 58.82716049382716%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABfElEQVQoz21S0W6EIBDkNy4nCCoiKOKJorlc26d7atL2sf//JR3ZXHNJO9HNijvM7AK7x/eX9Xv1H9f5M41fKdzfRr+nNGUsy4IYM8ZxDCFMDzRNwyZdB62uRgUjBy1dKy523tKW0ppSmucZdaANw9C2LQha6yZDKcUKLgXHK4pCFJwXvJxMty9xulygBuVLBvjYhZRpBXsxKUB8Rjl2YVvTmgEyxFEKjnOue4KUkok/5ND5fV0hCxqkyLPLIBrlR89/yVM3bEuEGshkmwbmvccuPgNJVVX/kL2Z9rSRbfKMamstNNsMYwxiXdeMF+X5fOb8oOHhx8DMFueQh/yrTG3TqOYMDJ7B2u326txQYNBCat0uMaJRtIQ6iEBBZ9AJ5bTFW9WawT2KmqbmWV0pue87FvGJoyF7BKKiVZ4hypIhnk6nAqcsBK2iVVwPVI9DtJ0zGZDCrcDxyKM9frQnBMMPGgYliH3fY0KHz/rQUQ+AqGDE9ZW1lXO17X8AHtVzUomFSmAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Process List\"\n        title=\"\"\n        src=\"/static/0ce027380578a5a9415fdb466efbf208/b9e4f/pm2-process-list.png\"\n        srcset=\"/static/0ce027380578a5a9415fdb466efbf208/cf440/pm2-process-list.png 148w,\n/static/0ce027380578a5a9415fdb466efbf208/d2d38/pm2-process-list.png 295w,\n/static/0ce027380578a5a9415fdb466efbf208/b9e4f/pm2-process-list.png 590w,\n/static/0ce027380578a5a9415fdb466efbf208/f9b6a/pm2-process-list.png 885w,\n/static/0ce027380578a5a9415fdb466efbf208/2d849/pm2-process-list.png 1180w,\n/static/0ce027380578a5a9415fdb466efbf208/bbefa/pm2-process-list.png 1770w,\n/static/0ce027380578a5a9415fdb466efbf208/0eb29/pm2-process-list.png 3240w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h3>Heapdumps analisis</h3>\n<p>By <code class=\"language-text\">Comparison</code> option via Chrome Dev Tools you can detect memory delta between heapdumps</p>\n<p><img src=\"/heapdump-devtools-fe0538e71febd61b669174b0b33861ac.gif\" alt=\"Heapdumps delta\"></p>\n<p>The most important thing is to determine the leak - when analyzing it is most useful to study the closure section, it may contain useful information. Next, in the screenshot, we see a percentage increase <code class=\"language-text\">Retained size</code>:</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1f8260d177959efc15098f43e556984c/72b2b/memory-leak-example.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 44.600795350260015%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAAA90lEQVQoz4VS7W7DIAzk/R9u0tZNndRprdKkCUnBxnwVSNK5U7Q/S7bTgUDmfGcJUZ1rZ20t1UejLhA+JZ6kaZSrf7Ea6CTx2MGxW3axf99XVXVo4Ons3oZxYb/CV1l2XWa+dOn5EncyC6UUAHpLKdj7/5gfa56nUvggjDEh+H5QvULnA5F13vsQNxi4rgHZDw0JRLTWOuehln3bGaLxG9Ma2DPnwr3ZgNWLOOdUyJJCQA4S+NFWbm6RUooxkjGP2ETEdy6kkFXPobCU8S8xmwNc21aw7Y+YEW3UV+AxtsynkcXZG1wR87Cojdaag205324pxMi/4wtcRATi8HzeCwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Memory Leak Example\"\n        title=\"\"\n        src=\"/static/1f8260d177959efc15098f43e556984c/b9e4f/memory-leak-example.png\"\n        srcset=\"/static/1f8260d177959efc15098f43e556984c/cf440/memory-leak-example.png 148w,\n/static/1f8260d177959efc15098f43e556984c/d2d38/memory-leak-example.png 295w,\n/static/1f8260d177959efc15098f43e556984c/b9e4f/memory-leak-example.png 590w,\n/static/1f8260d177959efc15098f43e556984c/f9b6a/memory-leak-example.png 885w,\n/static/1f8260d177959efc15098f43e556984c/2d849/memory-leak-example.png 1180w,\n/static/1f8260d177959efc15098f43e556984c/bbefa/memory-leak-example.png 1770w,\n/static/1f8260d177959efc15098f43e556984c/72b2b/memory-leak-example.png 3269w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2>Autocannon Benchmark</h2>\n<p>Instead the <code class=\"language-text\">Yandex Tank</code> your can use the <a href=\"https://github.com/mcollina/autocannon\">Autocannon</a> is fast HTTP/1.1 benchmarking tool written in Node.js</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token comment\"># Send requests to localhost:3000 during 10 seconds</span>\n$ npx autocannon -c 1 -d 10 localhost:3000</code></pre></div>","frontmatter":{"title":"Yandex Tank Benchmark setup and Detecting memory leaks","date":"January 24, 2019"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/yandex-tank-benchmark/","previous":{"fields":{"slug":"/pwa-icon-to-home/"},"frontmatter":{"title":"Add a PWA icon to home screen"}},"next":null}}